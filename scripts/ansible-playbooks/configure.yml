---
- hosts: firewall
  connection: local
  remote_user: admin
  gather_facts: no

  vars:
    third_octet: "32" # TODO: UPDATE ME!!! 20 + Team Number
    external_ip_address: "172.31.{{ third_octet }}.2/29"
    provider:
      ip_address: "172.20.242.150"
      password: "Changeme123" # TODO: UPDATE ME!!!
      port: 443
      username: "admin"

        # TODO: Set login banner to the warning banner
        # TODO: Change Policies and Address Groups to Account for NAT
        # TODO: Change what interface syslog exits out of (device -> services -> syslog)
        # TODO: Break File into Stages and make bash script
  tasks:
    - name: Create Allow-Ping Management Profile
      paloaltonetworks.panos.panos_management_profile:
        provider: '{{ provider }}'
        name: 'Allow-Ping'
        ping: true
        permitted_ip: ['172.20.240.0/24', '172.20.241.0/24', '172.20.242.0/24']

    - name: Create Allow-HTTPS-SSH-Ping Management Profile
      paloaltonetworks.panos.panos_management_profile:
        provider: '{{ provider }}'
        name: 'Allow-HTTPS-SSH-Ping'
        https: true
        ssh: true
        ping: true
        permitted_ip: ['172.20.242.0/24']

    - name: Create Nothing Management Profile
      paloaltonetworks.panos.panos_management_profile:
        provider: '{{ provider }}'
        name: 'Nothing'

    - name: Set Ethernet1/1 (PUBLIC) Management Profile
      paloaltonetworks.panos.panos_interface:
        provider: '{{ provider }}'
        if_name: "ethernet1/1"
        zone_name: "Public"
        management_profile: "Allow-Ping"
        vr_name: "RT1"
        ip: "172.20.241.254/24"
        enable_dhcp: false
        comment: "Public"
        state: replaced

    - name: Set Ethernet1/2 (INTERNAL) Management Profile
      paloaltonetworks.panos.panos_interface:
        provider: '{{ provider }}'
        if_name: "ethernet1/2"
        zone_name: "Internal"
        management_profile: "Allow-Ping"
        vr_name: "RT1"
        ip: "172.20.240.254/24"
        enable_dhcp: false
        comment: "Internal"
        state: replaced

    - name: Set Ethernet1/3 (EXTERNAL) Management Profile
      paloaltonetworks.panos.panos_interface:
        provider: '{{ provider }}'
        if_name: "ethernet1/3"
        zone_name: "External"
        management_profile: "Nothing"
        vr_name: "RT1"
        ip: '{{ external_ip_address }}'
        enable_dhcp: false
        comment: "External"
        state: replaced

    - name: Set Ethernet1/4 (USER) Management Profile
      paloaltonetworks.panos.panos_interface:
        provider: '{{ provider }}'
        if_name: "ethernet1/4"
        zone_name: "User"
        management_profile: "Allow-HTTPS-SSH-Ping"
        vr_name: "RT1"
        ip: "172.20.242.254/24"
          #enable_dhcp: false
        comment: "User"
        state: replaced

    - name: Commit Interface Changes
      paloaltonetworks.panos.panos_commit_firewall:
        provider: '{{ provider }}'

    - name: Create Web Traffic Application Group
      paloaltonetworks.panos.panos_application_group:
        provider: '{{ provider }}'
        name: 'web-traffic'
        value:
          - web-browsing
          - ssl
          - git
          - github

    - name: Create Windows Updates Application Group
      paloaltonetworks.panos.panos_application_group:
        provider: '{{ provider }}'
        name: 'windows-updates'
        value:
          - ms-update

    - name: Create Linux Updates Application Group
      paloaltonetworks.panos.panos_application_group:
        provider: '{{ provider }}'
        name: 'linux-updates'
        value:
          - apt-get
          - yum

    - name: Create Webmail Application Group
      paloaltonetworks.panos.panos_application_group:
        provider: '{{ provider }}'
        name: 'webmail'
        value:
          - smtp
          - pop3
          - imap

    - name: Create ICMP-Ping Application Group
      paloaltonetworks.panos.panos_application_group:
        provider: '{{ provider }}'
        name: 'icmp-ping'
        value:
          - icmp
          - ipv6-icmp
          - ping

    - name: Create Active Directory Application Group
      paloaltonetworks.panos.panos_application_group:
        provider: '{{ provider }}'
        name: 'windows-active-directory'
        value:
          - active-directory
          - ldap
          - ms-ds-smb
          - kerberos

    - name: Create Placeholder Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'placeholder'
        value: '169.254.74.75/32'
        description: 'Placeholder IP address for the blacklist group'

    - name: Create Private Public Network Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'public-net-private'
        value: '172.20.241.0/24'
        description: 'The public subnet'

    - name: Create Private User Network Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'user-net-private'
        value: '172.20.242.0/24'
        description: 'The user subnet'

    - name: Create Private Network Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'internal-net-private'
        value: '172.20.240.0/24'
        description: 'The internal subnet'

    - name: Create NAT Public Network Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'public-net-nat'
        value: '172.25.{{ third_octet }}.151/24'
        description: 'The nat translation to the public subnet'

    - name: Create NAT User Network Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'user-net-nat'
        value: '172.25.{{ third_octet }}.152/24'
        description: 'The nat translation to the user subnet'

    - name: Create NAT Internal Network Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'internal-net-nat'
        value: '172.25.{{ third_octet }}.150/24'
        description: 'The nat translation to the internal subnet'
 
    - name: Create 2016 Docker/Remote Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'docker-remote'
        value: '172.20.240.10/24'
        description: '2016 Docker/Remote Machine'

    - name: Create Debian 10 DNS/NTP Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'debian-dns-ntp'
        value: '172.20.240.20/24'
        description: 'Debian 10 DNS/NTP Machine'

    - name: Create NAT Debian 10 DNS/NTP Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'debian-dns-ntp-nat'
        value: '172.25.{{ third_octet }}.20/24'
        description: 'Debian 10 DNS/NTP Machine NAT'

    - name: Create NAT 2016 Docker/Remote Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'docker-remote-nat'
        value: '172.25.{{ third_octet }}.97/24'
        description: '2016 Docker/Remote Machine NAT'

    - name: Create NAT 2019 AD/DNS Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'windows-server-2019-nat'
        value: '172.25.{{ third_octet }}.27/24'
        description: '2019 AD/DNS/DHCP Machine NAT'

    - name: Create NAT Fedora Webmail Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'fedora-webmail-nat'
        value: '172.25.{{ third_octet }}.39/24'
        description: 'Fedora webmail NAT'

    - name: Create NAT Splunk Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'splunk-nat'
        value: '172.25.{{ third_octet }}.9/24'
        description: 'Splunk NAT'

    - name: Create NAT Ubuntu 18 Web Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'ubuntu-web-nat'
        value: '172.25.{{ third_octet }}.23/24'
        description: 'Ubuntu web NAT'

    - name: Create Ubuntu 18 Web Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'ubuntu-web'
        value: '172.20.242.10/24'
        description: 'Ubuntu 18 Web Machine'

    - name: Create 2019 AD/DNS/DHCP Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'windows-server-2019'
        value: '172.20.242.200/24'
        description: '2019 AD/DNS/DHCP Machine'

    - name: Create Splunk 9.1.1 Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'splunk'
        value: '172.20.241.20/24'
        description: 'Splunk 9.1.1 Machine'

    - name: Create CentOS 7 E-comm Internal Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'centos-ecomm-internal'
        value: '172.20.241.30/24'
        description: 'CentOS 7 E-Comm Machine'

    - name: Create CentOS 7 E-comm Translated Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'centos-ecomm-nat'
        value: '172.25.{{ third_octet }}.11/24'
        description: 'CentOS 7 E-Comm Machine NAT'

    - name: Create Fedora 21 Webmail/WebApps Address Object
      paloaltonetworks.panos.panos_address_object:
        provider: '{{ provider }}'
        name: 'fedora-webmail'
        value: '172.20.241.40/24'
        description: 'Fedora 21 Webmail/WebApps Machine'

    - name: Create IP-Address Blacklist Group
      paloaltonetworks.panos.panos_address_group:
        provider: '{{ provider }}'
        name: 'blacklist'
        static_value: ['placeholder']

    - name: Create GUIs Address Group
      paloaltonetworks.panos.panos_address_group:
        provider: '{{ provider }}'
        name: 'guis'
        static_value: ['windows-server-2019', 'debian-dns-ntp', 'docker-remote']

    - name: Create SNMP Server Address Group
      paloaltonetworks.panos.panos_address_group:
        provider: '{{ provider }}'
        name: 'snmp-server'
        static_value: ['placeholder']

    - name: Create All Machines Address Group
      paloaltonetworks.panos.panos_address_group:
        provider: '{{ provider }}'
        name: 'all-company-machines'
        static_value: ['docker-remote', 'debian-dns-ntp', 'ubuntu-web', 'windows-server-2019', 'splunk', 'centos-ecomm', 'fedora-webmail', 'user-net']

    - name: Create Internal Network Address Group
      paloaltonetworks.panos.panos_address_group:
        provider: '{{ provider }}'
        name: 'internal-subnet'
        static_value: ['docker-remote', 'debian-dns-ntp']

    - name: Create Internal Network NAT Address Group
      paloaltonetworks.panos.panos_address_group:
        provider: '{{ provider }}'
        name: 'internal-subnet-nat'
        static_value: ['docker-remote-nat', 'debian-dns-ntp-nat']

    - name: Create User Network Address Group
      paloaltonetworks.panos.panos_address_group:
        provider: '{{ provider }}'
        name: 'user-subnet'
        static_value: ['ubuntu-web', 'windows-server-2019']

    - name: Create User Network NAT Address Group
      paloaltonetworks.panos.panos_address_group:
        provider: '{{ provider }}'
        name: 'user-subnet-nat'
        static_value: ['ubuntu-web-nat', 'windows-server-2019-nat']

    - name: Create Public Network Address Group
      paloaltonetworks.panos.panos_address_group:
        provider: '{{ provider }}'
        name: 'public-subnet'
        static_value: ['splunk', 'centos-ecomm', 'fedora-webmail']

    - name: Create Public Network NAT Address Group
      paloaltonetworks.panos.panos_address_group:
        provider: '{{ provider }}'
        name: 'public-subnet-nat'
        static_value: ['splunk-nat', 'centos-ecomm-nat', 'fedora-webmail-nat']

    - name: Create Internal DNS Servers Address Group
      paloaltonetworks.panos.panos_address_group:
        provider: '{{ provider }}'
        name: 'internal-dns-servers'
        static_value: ['debian-dns-ntp', 'windows-server-2019']

    - name: Create Internal DNS Servers NAT Address Group
      paloaltonetworks.panos.panos_address_group:
        provider: '{{ provider }}'
        name: 'internal-dns-servers-nat'
        static_value: ['debian-dns-ntp-nat', 'windows-server-2019-nat']

    - name: Create Internal NTP Servers Address Group
      paloaltonetworks.panos.panos_address_group:
        provider: '{{ provider }}'
        name: 'internal-ntp-servers'
        static_value: ['debian-dns-ntp']

    - name: Create Splunk Web Service Object
      paloaltonetworks.panos.panos_service_object:
        provider: '{{ provider }}'
        name: 'splunk-web-service'
        destination_port: '8000'
        description: 'Splunk web ui service'

    - name: Create Splunk Management Service Object
      paloaltonetworks.panos.panos_service_object:
        provider: '{{ provider }}'
        name: 'splunk-management-service'
        destination_port: '8089'
        description: 'Splunk management and rest api service'

    - name: Create Splunk Indexing Service Object
      paloaltonetworks.panos.panos_service_object:
        provider: '{{ provider }}'
        name: 'splunk-indexing-service'
        destination_port: '9997'
        description: 'Splunk indexing service'

    - name: Create Splunk Index Replication Service Object
      paloaltonetworks.panos.panos_service_object:
        provider: '{{ provider }}'
        name: 'splunk-index-replication-service'
        destination_port: '8080'
        description: 'Splunk index replication service'

    - name: Create Splunk Syslog Service Object
      paloaltonetworks.panos.panos_service_object:
        provider: '{{ provider }}'
        name: 'splunk-syslog-service'
        destination_port: '514'
        description: 'Splunk syslog network input service'

    - name: Create Splunk Services Group
      paloaltonetworks.panos.panos_service_group:
        provider: '{{ provider }}'
        name: 'splunk-services'
        value: ['splunk-web-service', 'splunk-management-service', 'splunk-indexing-service', 'splunk-index-replication-service', 'splunk-syslog-service']

    - name: Create Splunk Syslog Profile
      paloaltonetworks.panos.panos_type_cmd:
        provider: '{{ provider }}'
        xpath: |
          /config/shared/log-settings/syslog/entry[@name='Splunk Syslog Profile']
          /server/entry[@name='splunk-server']
        element: |
          <server>172.20.241.20</server>
          <format>BSD</format>
          <port>1738</port>
          <transport>TCP</transport>
          <facility>LOG_USER</facility>

    - name: Create Splunk Log Forwarding Profile
      paloaltonetworks.panos.panos_log_forwarding_profile:
        provider: '{{ provider }}'
        name: 'Splunk Log Forwarding'
        enhanced_logging: false

    - name: Create Splunk Traffic Match List
      paloaltonetworks.panos.panos_log_forwarding_profile_match_list:
        provider: '{{ provider }}'
        log_forwarding_profile: 'Splunk Log Forwarding'
        name: 'sp-traffic'
        description: 'Splunk syslog traffic log forwarding'
        log_type: 'traffic'
        syslog_profiles: ['Splunk Syslog Profile']
        filter: "(addr.src in '10.0.0.0/8')"

    - name: Create Splunk Auth Match List
      paloaltonetworks.panos.panos_log_forwarding_profile_match_list:
        provider: '{{ provider }}'
        log_forwarding_profile: 'Splunk Log Forwarding'
        name: 'sp-auth'
        description: 'Splunk syslog auth log forwarding'
        log_type: 'auth'
        syslog_profiles: ['Splunk Syslog Profile']
        filter: "(ip in '10.0.0.0/8')"

    - name: Create Splunk Data Match List
      paloaltonetworks.panos.panos_log_forwarding_profile_match_list:
        provider: '{{ provider }}'
        log_forwarding_profile: 'Splunk Log Forwarding'
        name: 'sp-data'
        description: 'Splunk syslog data log forwarding'
        log_type: 'data'
        syslog_profiles: ['Splunk Syslog Profile']
        filter: "(addr in '10.0.0.0/8')"

          #- name: Create Splunk Decryption Match List
          #paloaltonetworks.panos.panos_log_forwarding_profile_match_list:
          #provider: '{{ provider }}'
          #log_forwarding_profile: 'Splunk Log Forwarding'
          #name: 'sp-decryption'
          #description: 'Splunk syslog decryption log forwarding'
          #log_type: 'decryption'
          #syslog_profiles: ['Splunk Syslog Profile']

    - name: Create Splunk Threat Match List
      paloaltonetworks.panos.panos_log_forwarding_profile_match_list:
        provider: '{{ provider }}'
        log_forwarding_profile: 'Splunk Log Forwarding'
        name: 'sp-threat'
        description: 'Splunk syslog threat log forwarding'
        log_type: 'threat'
        syslog_profiles: ['Splunk Syslog Profile']
        filter: "(addr in '10.0.0.0/8')"

          #- name: Create Splunk Tunnel Match List
          #paloaltonetworks.panos.panos_log_forwarding_profile_match_list:
          #provider: '{{ provider }}'
          #log_forwarding_profile: 'Splunk Log Forwarding'
          #name: 'sp-tunnel'
          #description: 'Splunk syslog tunnel log forwarding'
          #log_type: 'tunnel'
          #syslog_profiles: ['Splunk Syslog Profile']

    - name: Create Splunk URL Match List
      paloaltonetworks.panos.panos_log_forwarding_profile_match_list:
        provider: '{{ provider }}'
        log_forwarding_profile: 'Splunk Log Forwarding'
        name: 'sp-url'
        description: 'Splunk syslog URL log forwarding'
        log_type: 'url'
        syslog_profiles: ['Splunk Syslog Profile']
        filter: "(addr in '10.0.0.0/8')"

          #- name: Create Splunk Wildfire Match List
          #paloaltonetworks.panos.panos_log_forwarding_profile_match_list:
          #provider: '{{ provider }}'
          #log_forwarding_profile: 'Splunk Log Forwarding'
          #name: 'sp-wildfire'
          #description: 'Splunk syslog wildfire log forwarding'
          #log_type: 'wildfire'
          #syslog_profiles: ['Splunk Syslog Profile']
      
    - name: Change Syslog Service Route Configuration
      paloaltonetworks.panos.panos_type_cmd:
        provider: '{{ provider }}'
        cmd: 'set'
        xpath: |
          /config/devices/entry[@name='localhost.localdomain']
          /deviceconfig/system/route/service/entry[@name='syslog']
          /source
        element: |
          <interface>ethernet1/1</interface>
          <address>172.20.241.254/24</address>


    - name: Delete Default 'any2any' Security Policy
      paloaltonetworks.panos.panos_type_cmd:
        provider: '{{ provider }}'
        cmd: 'delete'
        xpath: |
          /config/devices/entry[@name='localhost.localdomain']
          /vsys/entry[@name='vsys1']
          /rulebase/security/rules/entry[@name='any2any']

    - name: Delete Default 'PUBLIC2EXTERNAL' Security Policy
      paloaltonetworks.panos.panos_type_cmd:
        provider: '{{ provider }}'
        cmd: 'delete'
        xpath: |
          /config/devices/entry[@name='localhost.localdomain']
          /vsys/entry[@name='vsys1']
          /rulebase/security/rules/entry[@name='PUBLIC2EXTERNAL']

    - name: Delete Default 'PUBLIC2INTERNAL' Security Policy
      paloaltonetworks.panos.panos_type_cmd:
        provider: '{{ provider }}'
        cmd: 'delete'
        xpath: |
          /config/devices/entry[@name='localhost.localdomain']
          /vsys/entry[@name='vsys1']
          /rulebase/security/rules/entry[@name='PUBLIC2INTERNAL']

    - name: Delete Default 'INTERNAL2PUBLIC' Security Policy
      paloaltonetworks.panos.panos_type_cmd:
        provider: '{{ provider }}'
        cmd: 'delete'
        xpath: |
          /config/devices/entry[@name='localhost.localdomain']
          /vsys/entry[@name='vsys1']
          /rulebase/security/rules/entry[@name='INTERNAL2PUBLIC']

    - name: Reconfigure Default Interzone Security Policy
      paloaltonetworks.panos.panos_type_cmd:
        provider: '{{ provider }}'
        xpath: |
          /config/devices/entry[@name='localhost.localdomain']
          /vsys/entry[@name='vsys1']
          /rulebase/default-security-rules/rules/entry[@name='interzone-default']
        element: |
          <action>drop</action>
          <icmp-unreachable>yes</icmp-unreachable>
          <log-end>yes</log-end>
          <log-start>yes</log-start>
          <log-setting>Splunk Log Forwarding</log-setting>

          #TODO: Delete unnecessary configs (global, etc)

    - name: Commit Security Policy Changes
      paloaltonetworks.panos.panos_commit_firewall:
        provider: '{{ provider }}'

    - name: Reset All Sessions
      paloaltonetworks.panos.panos_op:
        provider: '{{ provider }}'
        cmd: 'clear session all'

    - name: Create 'Block Outbound Blacklisted IPs' Security Policy
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'Deny blacklisted egress'
        description: 'Drop traffic with a blacklisted destination address from escaping the network.'
        source_zone: ['Internal', 'Public', 'User']
        source_ip: ['any']
        destination_zone: ['External']
        destination_ip: ['blacklist']
        application: ['any']
        service: ['any']
        action: 'drop'
        log_setting: 'Splunk Log Forwarding'
        location: 'bottom'

    - name: Create 'Block Inbound Blacklisted IPs' Security Policy
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'Deny blacklisted ingress'
        description: 'Drop traffic with a blacklisted source address from entering the network.'
        source_zone: ['External']
        source_ip: ['blacklist']
        destination_zone: ['Internal', 'Public', 'User']
        destination_ip: ['any']
        application: ['any']
        service: ['any']
        action: 'drop'
        log_setting: 'Splunk Log Forwarding'
        location: 'bottom'

    - name: Create 'Outbound Company Traffic' Security Policy
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'Company Traffic Egress'
        description: 'Controls which traffic is permitted to exit the company perimeter.'
        source_zone: ['Internal', 'Public', 'User']
        source_ip: ['any']
        destination_zone: ['External']
        destination_ip: ['any']
        application: ['dns', 'ntp', 'windows-updates', 'linux-updates', 'web-traffic', 'webmail', 'icmp-ping']
        action: 'allow'
        log_setting: 'Splunk Log Forwarding'
        location: 'bottom'

    - name: Create 'External to Public' Security Policy
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'External to Public'
        description: 'Controls which traffic is permitted to access the public network from the external network.'
        source_zone: ['External']
        source_ip: ['any']
        destination_zone: ['Public']
        destination_ip: ['public-subnet-nat']
        application: ['icmp-ping', 'linux-updates', 'web-traffic', 'webmail']
        action: 'allow'
        log_setting: 'Splunk Log Forwarding'
        location: 'bottom'


    - name: Create 'External to Splunk' Security Policy
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'External to Splunk'
        description: 'Allows external web-browsing to splunk'
        source_zone: ['External']
        source_ip: ['any']
        destination_zone: ['Public']
        destination_ip: ['splunk-nat']
        application: ['web-browsing']
        service: ['splunk-web-service']
        action: 'allow'
        log_setting: 'Splunk Log Forwarding'
        location: 'bottom'

    - name: Create 'External to User' Security Policy
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'External to User'
        description: 'Controls which traffic is permitted to access the user network from the external network.'
        source_zone: ['External']
        source_ip: ['any']
        destination_zone: ['User']
        destination_ip: ['user-net-nat', 'user-subnet-nat']
        application: ['dns', 'icmp-ping', 'linux-updates', 'web-traffic', 'windows-updates']
        action: 'allow'
        log_setting: 'Splunk Log Forwarding'
        location: 'bottom'

    - name: Create 'External to Internal' Security Policy
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'External to Internal'
        description: 'Controls which traffic is permitted to access the internal network from the external network.'
        source_zone: ['External']
        source_ip: ['any']
        destination_zone: ['Internal']
        destination_ip: ['internal-subnet-nat']
        application: ['dns', 'icmp-ping', 'linux-updates', 'ntp', 'web-traffic', 'windows-updates']
        action: 'allow'
        log_setting: 'Splunk Log Forwarding'
        location: 'bottom'

    - name: Create 'Internal Servers to Splunk' Security Policy
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'Allow servers to splunk'
        description: 'Allow all company servers to forward logs to splunk.'
        source_zone: ['Internal', 'Public', 'User']
        source_ip: ['all-company-machines']
        destination_zone: ['Public']
        destination_ip: ['splunk']
        application: ['any']
        service: ['splunk-indexing-service', 'splunk-syslog-service']
        action: 'allow'
        log_setting: 'Splunk Log Forwarding'
        location: 'bottom'

          # - name: Create 'Splunk to Internal Servers' Security Policy

    - name: Create 'Servers to DNS/NTP' Security Policy
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'Allow servers to DNS and NTP'
        description: 'Allow all company servers to communicate with internal DNS and NTP servers.'
        source_zone: ['Internal', 'Public', 'User']
        source_ip: ['all-company-machines']
        destination_zone: ['Internal', 'User']
        destination_ip: ['internal-dns-servers', 'internal-ntp-servers']
        application: ['dns', 'ntp']
        action: 'allow'
        log_setting: 'Splunk Log Forwarding'
        location: 'bottom'

    - name: Create 'DNS/NTP to Servers' Security Policy
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'Allow DNS and NTP to servers'
        description: 'Allow internal DNS and NTP servers to communicate with all company machines.'
        source_zone: ['User', 'Internal']
        source_ip: ['internal-dns-servers', 'internal-ntp-servers']
        destination_zone: ['Internal', 'User', 'Public']
        destination_ip: ['all-company-machines']
        application: ['dns', 'ntp']
        action: 'allow'
        log_setting: 'Splunk Log Forwarding'
        location: 'bottom'

    - name: Create 'Webmail to Active Directory' Security Policy
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'Allow Webmail to Active Directory'
        description: 'Allow the webmail/webapps server to communicate with the active directory server.'
        source_zone: ['Public']
        source_ip: ['fedora-webmail']
        destination_zone: ['User']
        destination_ip: ['windows-server-2019']
        application: ['windows-active-directory']
        action: 'allow'
        log_setting: 'Splunk Log Forwarding'
        location: 'bottom'

    - name: Create 'Active Directory to Webmail' Security Policy
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'Allow Active Directory to Webmail'
        description: 'Allow the active directory server to communicate with the webmail/webapps server.'
        source_zone: ['User']
        source_ip: ['windows-server-2019']
        destination_zone: ['Public']
        destination_ip: ['fedora-webmail']
        application: ['windows-active-directory']
        action: 'allow'
        log_setting: 'Splunk Log Forwarding'
        location: 'bottom'

    - name: Create 'GUIs to Splunk' Security Policy # Combine bi-directionality into one rule
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'Allow GUIs to Splunk'
        description: 'Allow all company machines with a GUI to access the internal Splunk server.'
        source_zone: ['Internal', 'User', 'Public']
        source_ip: ['all-company-machines']
        destination_zone: ['Public']
        destination_ip: ['splunk']
        application: ['any']
        service: ['splunk-services']
        action: 'allow'
        location: 'bottom'

      # - name: Create 'Splunk to GUIs' Security Policy

    - name: Create 'Internal Servers to SNMP Server' Security Policy
      paloaltonetworks.panos.panos_security_rule:
        provider: '{{ provider }}'
        rule_name: 'Allow Servers to SNMP'
        description: 'Allow all internal machines to communicate with the internal SNMP server.'
        source_zone: ['Internal', 'User', 'Public']
        source_ip: ['all-company-machines']
        destination_zone: ['Internal', 'User']
        destination_ip: ['snmp-server']
        application: ['snmp']
        action: 'allow'
        log_setting: 'Splunk Log Forwarding'
        location: 'bottom'

    # - name: Create 'SNMP Server to Internal Servers' Security Policy

    - name: Commit Security Policy Changes
      paloaltonetworks.panos.panos_commit_firewall:
        provider: '{{ provider }}'

